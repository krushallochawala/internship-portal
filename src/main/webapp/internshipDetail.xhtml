<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:h="jakarta.faces.html"
      xmlns:f="jakarta.faces.core">

    <body>

        <ui:composition template="./Template/template.xhtml">

            <ui:define name="top">
                <ui:include src="./Template/header.xhtml"/>
            </ui:define>

            <ui:define name="content">
                <div class="breadcrumbs overlay">
                    <div class="container">
                        <div class="row">
                            <div class="col-12">
                                <div class="breadcrumbs-content">
                                    <h1 class="page-title">Internship Details</h1>
                                    <p>Business plan draws on a wide range of knowledge from different business<br /> disciplines.
                                        Business draws on a wide range of different business .</p>
                                </div>
                                <ul class="breadcrumb-nav">
                                    <li><a href="index.html">Home</a></li>
                                    <li>Internship Details</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="job-details section">
                    <div class="container">
                        <div class="row mb-n5">
                            <!-- Job List Details Start -->
                            <div class="col-lg-8 col-12">
                                <div class="job-details-inner">
                                    <div class="job-details-head row mx-0">
                                        <div class="company-logo col-auto">
                                            <a href="#" style="border-radius: 4px; overflow: hidden;"><p:graphicImage value="#{'http://localhost:55335/IntershipPortal-adminDashboard/resources/api/uploads/companyLogo/'.concat(internshipCDIBean.internship.companyId.logo)}"
                                                                                                                      alt="Company Logo" 
                                                                                                                      width="80" height="80" />
                                            </a>
                                        </div>
                                        <div class="salary-type col-auto order-sm-3">
                                            <span class="salary-range">#{internshipCDIBean.internship.status}</span>
                                            <span class="badge badge-success">#{internshipCDIBean.internship.internshipTime}</span>
                                        </div>
                                        <div class="content col">
                                            <h5 class="title">#{internshipCDIBean.internship.title}</h5>
                                            <ul class="meta">
                                                <li><strong class="text-primary"><a href="http://www.graygrids.com">#{internshipCDIBean.internship.companyId.name}</a></strong>
                                                </li>
                                                <li><i class="fas fa-map-marker-alt"></i> #{internshipCDIBean.internship.companyId.address}</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="job-details-body">
                                        <h6 class="mb-3">Internship Description</h6>
                                        <p>#{internshipCDIBean.internship.description}</p>
                                        <h6 class="mb-3 mt-4">Required Skills</h6>
                                        <ul>
                                            <ui:repeat value="${internshipCDIBean.internshipSkills}" var="skill">
                                                <li>#{skill.skillId.skill}</li>
                                            </ui:repeat>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <!-- Job List Details End -->
                            <!-- Job Sidebar Wrap Start -->
                            <div class="col-lg-4 col-12">
                                <div class="job-details-sidebar">
                                    <!-- Sidebar (Apply Buttons) Start -->
                                    <div class="sidebar-widget">
                                        <div class="inner">
                                            <div class="row m-n2 button">
                                                <div class="col-xl-auto col-lg-12 col-sm-auto col-12 p-2">
                                                    <h:form>
                                                        <p:commandLink action="#{studentCDIBean.saveInternship(internshipCDIBean.internship.id)}" class="d-block btn" ajax="false"><i class="fa fa-heart-o mr-1"></i> Save Internship</p:commandLink>
                                                    </h:form>

                                                    <h:form id="applyForm" style="display:none;">
                                                        <p:commandButton id="applyBtn"
                                                                         action="#{studentCDIBean.applyInternship(internshipCDIBean.internship.id)}"
                                                                         ajax="false" />
                                                    </h:form>

                                                </div>
                                                <div class="col-xl-auto col-lg-12 col-sm-auto col-12 p-2">
                                                    <p:commandButton class="d-block btn-alt" style="padding:6px 20px;" oncomplete="checkLoginAndLaunchPayment()" value="Apply Now"></p:commandButton>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Sidebar (Apply Buttons) End -->
                                    <div class="sidebar-widget">
                                        <div class="inner">
                                            <h6 class="title">Internship Overview</h6>
                                            <ul class="job-overview list-unstyled">
                                                <li><strong>Published on:</strong> #{internshipCDIBean.internship.createdAt}</li>
                                                <li><strong>Vacancy:</strong> #{internshipCDIBean.internship.totalRequiredInterns}</li>
                                                <li><strong>Employment Status:</strong> #{internshipCDIBean.internship.internshipTime}</li>
                                                <li><strong>Internship Location:</strong> #{internshipCDIBean.internship.location}</li>
                                                <li><strong>Stipend:</strong> #{empty internshipCDIBean.internship.stipend ? "N/A" : internshipCDIBean.internship.stipend}</li>
                                                <li><strong>Paid:</strong>#{internshipCDIBean.internship.paid}</li>
                                                <h:panelGroup rendered="#{internshipCDIBean.internship.paid}">
                                                    <li><strong>Amount:</strong> â‚¹#{internshipCDIBean.internship.amount}</li>
                                                </h:panelGroup>

                                                <li><strong>Application Deadline:</strong> #{internshipCDIBean.internship.applicationDeadline}</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <!-- Sidebar (Job Overview) End -->
                                </div>
                            </div>
                            <!-- Job Sidebar Wrap End -->
                        </div>
                    </div>
                </div>

                <!-- Feedback Form Section -->
                <h:panelGroup>
                    <div class="container py-5">
                        <div class="row justify-content-center">
                            <div class="col-lg-8 col-md-10">
                                <!-- Card with shadow -->
                                <div class="card shadow-lg p-4 border-0 rounded-3">
                                    <h3 class="mb-4 text-center">Share Your Feedback</h3>

                                    <h:form id="feedbackForm">

                                        <!-- Rating -->
                                        <div class="mb-3">
                                            <h:outputLabel value="Rating:" for="rating" />
                                            <p:rating id="rating" stars="5" value="#{studentCDIBean.feedback.rating}" required="true" />
                                        </div>

                                        <!-- Comment -->
                                        <div class="mb-3">
                                            <h:outputLabel value="Comments:" for="comment" />
                                            <p:inputTextarea id="comment"
                                                             rows="5" cols="60" autoResize="true" required="true"
                                                             value="#{studentCDIBean.feedback.comments}"
                                                             placeholder="Write about your internship experience..." />
                                        </div>

                                        <!-- Submit -->
                                        <div class="text-center">
                                            <p:commandButton value="Submit Feedback" 
                                                             update="feedbackForm msg"
                                                             icon="pi pi-user-edit" 
                                                             action="#{studentCDIBean.addFeedback()}">
                                                <f:setPropertyActionListener value="#{internshipCDIBean.internship.id}" target="#{studentCDIBean.internshipId}" />
                                            </p:commandButton>
                                        </div>
                                    </h:form>
                                </div>
                            </div>
                        </div>
                    </div>
                </h:panelGroup>



                <form id="razorpayForm" action="/student/applyStatus" method="POST" style="display: none;">
                    <input type="hidden" name="_token" value="#{csrf.token}" />
                    <input type="hidden" id="internshipId" value="#{studentCDIBean.internshipId}" name="internshipId" />
                    <input type="hidden" id="totalAmount" value="#{internshipCDIBean.internship.amount}" name="amount" />
                    <input type="hidden" id="razorpay_payment_id" value="#{studentCDIBean.payment.transactionId}" name="razorpay_payment_id" />
                    
                    <p:commandButton id="submitBtn"
                     action="#{studentCDIBean.handlePaidInternship()}"
                     style="display:none"
                     ajax="false" />
                </form>

                <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

                <script>
                    function launchPayment() {
                        var internshipId = "#{internshipCDIBean.internship.id}";
                        var internshipName = "#{internshipCDIBean.internship.title}";
                        var amount = #{internshipCDIBean.internship.amount * 100};

                        var options = {
                            "key": "rzp_test_kS80NTezFBTFjA",
                            "amount": amount,
                            "currency": "INR",
                            "name": "Internify",
                            "description": "Event Registration Fee",
                            "image": "https://your-logo-url.com/logo.png",
                            "handler": function (response) {
                                document.getElementById('internshipId').value = "#{internshipCDIBean.internship.id}";
                                document.getElementById('totalAmount').value = "#{internshipCDIBean.internship.amount}";
                                document.getElementById('razorpay_payment_id').value = response.razorpay_payment_id;
                                document.getElementById("razorpayForm:submitBtn").click();
                            },
                            "prefill": {
                                "name": "sakshi",
                                "email": "demo@email.com"
                            },
                            "theme": {
                                "color": "#F37254"
                            }
                        };
                        var rzp = new Razorpay(options);
                        rzp.open();
                    }
                </script>

                <script type="text/javascript">
                    function checkLoginAndLaunchPayment() {
                        var isLoggedIn = "#{studentCDIBean.loggedIn}" === "true";
                        var isPaid = "#{internshipCDIBean.internship.paid}" === "true";

                        if (!isLoggedIn) {
                            window.location.href = 'login.xhtml'; // adjust the login path if needed
                            return;
                        }

                        if (isPaid) {
                            launchPayment();
                        } else {
                            document.getElementById("applyForm:applyBtn").click();
                        }
                    }
                </script>

            </ui:define>

            <ui:define name="bottom">
                <ui:include src="./Template/footer.xhtml" />
            </ui:define>

        </ui:composition>

    </body>
</html>
